import{_ as e}from"./plugin-vue_export-helper.21dcd24c.js";import{r as o,o as c,c as l,a as n,b as t,e as s,d as p}from"./app.b5f28d2d.js";const i={},u=n("h1",{id:"freesql-cap\u4E8B\u52A1",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#freesql-cap\u4E8B\u52A1","aria-hidden":"true"},"#"),s(" FreeSql+CAP\u4E8B\u52A1")],-1),r=n("h2",{id:"\u80CC\u666F\u63CF\u8FF0",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#\u80CC\u666F\u63CF\u8FF0","aria-hidden":"true"},"#"),s(" \u80CC\u666F\u63CF\u8FF0")],-1),k=s("\u5728CAP\u4E2D\uFF0C\u4E8B\u52A1\u5BF9\u8C61\u9700\u8981\u4EA4\u7ED9CAP\u8FDB\u884C\u63D0\u4EA4\u4ECE\u800C\u5728\u4E8B\u52A1\u5B9E\u73B0\u63D0\u4EA4\u540E\u5BF9\u7F13\u5B58\u6D88\u606F\u5230 Broker \u7684 Flush \u52A8\u4F5C\uFF0C\u800C\u76EE\u524D\u7684Orm\u5927\u90E8\u5206\u90FD\u6709\u81EA\u5DF1\u7684\u4E8B\u52A1\u7BA1\u7406\u5BF9\u8C61\u8FDB\u884C\u4E8B\u52A1\u7684\u63D0\u4EA4\u3002CAP\u5B98\u65B9\u76F4\u63A5\u539F\u751F\u652F\u6301\u4F7F\u7528 "),d={href:"http://ADO.NET",target:"_blank",rel:"noopener noreferrer"},v=s("ADO.NET"),m=s(" \u548C EntityFrameworkCore \u8FDB\u884C\u4E8B\u52A1\u96C6\u6210\uFF0C\u800C\u5BF9\u4E8E\u7B2C\u4E09\u65B9ORM\u672C\u6587\u63D0\u4F9B\u4E86\u4E00\u79CD\u6269\u5C55\u7528\u4EE5\u96C6\u6210\u7684\u793A\u4F8B\u3002"),b=p(`<p>\u63A5\u5165\u6709\u4E8C\u79CD\u65B9\u5F0F</p><ul><li>\u5B89\u88C5<code>FreeSql</code>\u5305</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>dotnet <span class="token function">add</span> package FreeSql
dotnet <span class="token function">add</span> package FreeSql.DbContext
dotnet <span class="token function">add</span> package FreeSql.Provider.MySqlConnector
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u5B89\u88C5<code>CAP</code>\u76F8\u5173\u5305</li></ul><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>dotnet <span class="token function">add</span> package Savorboard.CAP.InMemoryMessageQueue
dotnet <span class="token function">add</span> package DotNetCore.CAP.MySql
dotnet <span class="token function">add</span> package DotNetCore.CAP.Dashboard
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u670D\u52A1" tabindex="-1"><a class="header-anchor" href="#\u670D\u52A1" aria-hidden="true">#</a> \u670D\u52A1</h2><ul><li>appsetttings.json</li></ul><div class="language-json ext-json line-numbers-mode"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;ConnectionStrings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;MySql&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Data Source=localhost;Port=3306;User ID=root;Password=root;Initial Catalog=lincms;Charset=utf8mb4;SslMode=none;Max pool size=1;Connection LifeTime=20&quot;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u914D\u7F6E\u76F8\u5173\u670D\u52A1</li></ul><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code> <span class="token class-name">IConfigurationSection</span> mysqlSelection <span class="token operator">=</span> configuration<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;ConnectionStrings:MySql&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">IFreeSql</span> fsql <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FreeSqlBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">UseConnectionString</span><span class="token punctuation">(</span>DataType<span class="token punctuation">.</span>MySql<span class="token punctuation">,</span>mysqlSelection<span class="token punctuation">.</span>Value<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">UseNameConvert</span><span class="token punctuation">(</span>NameConvertType<span class="token punctuation">.</span>PascalCaseToUnderscoreWithLower<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">UseAutoSyncStructure</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">UseMonitorCommand</span><span class="token punctuation">(</span>cmd <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> Trace<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>cmd<span class="token punctuation">.</span>CommandText <span class="token operator">+</span> <span class="token string">&quot;;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span>fsql<span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token function">AddFreeRepository</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddScoped</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>UnitOfWorkManager<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,10),h=s("CAP\u76F8\u5173\u670D\u52A1 "),g={href:"https://cap.dotnetcore.xyz/user-guide/zh/storage/mysql/",target:"_blank",rel:"noopener noreferrer"},y=s("https://cap.dotnetcore.xyz/user-guide/zh/storage/mysql/"),f=p(`<p>\u81F3\u5C11\u4F60\u8981\u914D\u7F6E\u4E00\u4E2A\u6D88\u606F\u961F\u5217\u548C\u4E00\u4E2A\u4E8B\u4EF6\u5B58\u50A8\uFF08UseMySql\uFF09</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code>  services<span class="token punctuation">.</span><span class="token function">AddCap</span><span class="token punctuation">(</span>x <span class="token operator">=&gt;</span>
    <span class="token punctuation">{</span>   
        x<span class="token punctuation">.</span><span class="token function">UseInMemoryMessageQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        x<span class="token punctuation">.</span><span class="token function">UseMySql</span><span class="token punctuation">(</span>opt<span class="token operator">=&gt;</span><span class="token punctuation">{</span>
            <span class="token comment">//MySqlOptions</span>
            opt<span class="token punctuation">.</span>ConnectionString <span class="token operator">=</span> mysqlSelection<span class="token punctuation">.</span>Value
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// x.UseXXX ...</span>
         x<span class="token punctuation">.</span><span class="token function">UseDashboard</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,2),w=s("\u9ED8\u8BA4\u60C5\u51B5\u4E0B\uFF0C\u4F60\u53EF\u4EE5\u8BBF\u95EE "),q={href:"http://localhost:xxx/cap",target:"_blank",rel:"noopener noreferrer"},C=s("http://localhost:xxx/cap"),S=s(" \u8FD9\u4E2A\u5730\u5740\u6253\u5F00Dashboard\u3002"),_=p(`<h2 id="\u65B9\u5F0F\u4E00" tabindex="-1"><a class="header-anchor" href="#\u65B9\u5F0F\u4E00" aria-hidden="true">#</a> \u65B9\u5F0F\u4E00</h2><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">CapUnitOfWorkExtensions</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Flush</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">ICapTransaction</span> capTransaction<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            capTransaction<span class="token punctuation">?.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span><span class="token string">&quot;Flush&quot;</span><span class="token punctuation">,</span> BindingFlags<span class="token punctuation">.</span>Instance <span class="token operator">|</span> BindingFlags<span class="token punctuation">.</span>NonPublic<span class="token punctuation">)</span><span class="token punctuation">?.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>capTransaction<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ICapTransaction</span> <span class="token function">BeginTransaction</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IUnitOfWork</span> unitOfWork<span class="token punctuation">,</span> <span class="token class-name">ICapPublisher</span> publisher<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">bool</span></span> autoCommit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//\u770B\u4E86\u6E90\u7801\uFF0C\u6362\u4E86\u65B0\u7684\u5199\u6CD5\uFF0C\u6362\u4E0D\u540C\u7684\u6570\u636E\u5E93\uFF0C\u5C31\u9700\u8981\u624B\u52A8\u4FEE\u6539\u8FD9\u6BB5\u4EE3\u7801\u4E86\uFF08MySqlCapTransaction\uFF09</span>
            <span class="token comment">//publisher.Transaction.Value = (ICapTransaction)publisher.ServiceProvider.GetService(typeof(ICapTransaction));\u65B0\u7248\u672C\u53EA\u80FD\u5F97\u5230null</span>
            publisher<span class="token punctuation">.</span>Transaction<span class="token punctuation">.</span>Value <span class="token operator">=</span> ActivatorUtilities<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateInstance</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>MySqlCapTransaction<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>publisher<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> publisher<span class="token punctuation">.</span>Transaction<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span>unitOfWork<span class="token punctuation">.</span><span class="token function">GetOrBeginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> autoCommit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Commit</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">ICapTransaction</span> capTransaction<span class="token punctuation">,</span> <span class="token class-name">IUnitOfWork</span> unitOfWork<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            unitOfWork<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            capTransaction<span class="token punctuation">.</span><span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>\u4F7F\u7528\u65B9\u5F0F</li></ul><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BookController</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">Controller</span></span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;~/freesql/unitofwork&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> <span class="token function">FreeSqlUnitOfWorkManagerTransaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromServices</span></span><span class="token punctuation">]</span> <span class="token class-name">IBaseRepository<span class="token punctuation">&lt;</span>Book<span class="token punctuation">&gt;</span></span> repo<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromServices</span></span><span class="token punctuation">]</span> <span class="token class-name">UnitOfWorkManager</span> unitOfWorkManager<span class="token punctuation">,</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromServices</span></span><span class="token punctuation">]</span> <span class="token class-name">ICapPublisher</span> capBus
    <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">DateTime</span> now <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IUnitOfWork</span> uow <span class="token operator">=</span> unitOfWorkManager<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">ICapTransaction</span> trans <span class="token operator">=</span> uow<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span>capBus<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            repo<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                Author <span class="token operator">=</span> <span class="token string">&quot;\u53F6\u8001\u677F&quot;</span><span class="token punctuation">,</span>
                Title <span class="token operator">=</span> <span class="token string">&quot;FreeSql\u6E90\u7801\u89E3\u6790\u4E0E\u5B9E\u6218&quot;</span><span class="token punctuation">,</span>
                Summary <span class="token operator">=</span> <span class="token string">&quot;\u5E26\u4F60\u4E86\u89E3FreeSql\u6E90\u7801\u7EC6\u8282\uFF0C\u638C\u63E1FreeSql\u7684\u5B9E\u6218\u64CD\u4F5C\uFF0C\u6269\u5C55FreeSql\u7684\u529F\u80FD\uFF0C\u63D0\u5347\u4F60\u7684\u5F00\u53D1\u6548\u7387\u3002&quot;</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            capBus<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token string">&quot;freesql.time&quot;</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            trans<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span>uow<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> now<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">NonAction</span></span><span class="token punctuation">]</span>
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">CapSubscribe</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;freesql.time&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">GetTime</span><span class="token punctuation">(</span><span class="token class-name">DateTime</span> time<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$&quot;time:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">time</span><span class="token punctuation">}</span></span><span class="token string">&quot;</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Table</span><span class="token attribute-arguments"><span class="token punctuation">(</span>Name <span class="token operator">=</span> <span class="token string">&quot;book&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Book</span> 
<span class="token punctuation">{</span>
   <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Column</span><span class="token attribute-arguments"><span class="token punctuation">(</span>IsIdentity <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> IsPrimary <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">long</span></span> Id <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 
   
    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Column</span><span class="token attribute-arguments"><span class="token punctuation">(</span>StringLength <span class="token operator">=</span> <span class="token number">30</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Author <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Column</span><span class="token attribute-arguments"><span class="token punctuation">(</span>StringLength <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Summary <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 

    <span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">Column</span><span class="token attribute-arguments"><span class="token punctuation">(</span>StringLength <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">string</span></span> Title <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> 

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="\u65B9\u5F0F\u4E8C" tabindex="-1"><a class="header-anchor" href="#\u65B9\u5F0F\u4E8C" aria-hidden="true">#</a> \u65B9\u5F0F\u4E8C</h2><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FreeSqlRepositoryPatternTransaction</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">CapTransactionBase</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token function">FreeSqlRepositoryPatternTransaction</span><span class="token punctuation">(</span><span class="token class-name">IDispatcher</span> dispatcher<span class="token punctuation">,</span> <span class="token class-name">IUnitOfWork</span> uow<span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token keyword">base</span><span class="token punctuation">(</span>dispatcher<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Uow <span class="token operator">=</span> uow<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token return-type class-name">IUnitOfWork</span> Uow <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">object</span><span class="token punctuation">?</span></span> DbTransaction <span class="token operator">=&gt;</span> Uow<span class="token punctuation">.</span><span class="token function">GetOrBeginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Uow<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">Flush</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">CommitAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NotImplementedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Uow<span class="token punctuation">.</span><span class="token function">Rollback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name">Task</span> <span class="token function">RollbackAsync</span><span class="token punctuation">(</span><span class="token class-name">CancellationToken</span> cancellationToken <span class="token operator">=</span> <span class="token keyword">default</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NotImplementedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Uow<span class="token punctuation">.</span><span class="token function">Dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Extensions</span>
<span class="token punctuation">{</span>
      <span class="token comment">// \u6CE8\u610F\uFF1A\u4F60\u53EF\u4EE5\u914C\u60C5\u4FEE\u6539\u6B64\u6269\u5C55\u4EE5\u652F\u6301\u4F60\u7684\u4F7F\u7528\u4E60\u60EF\uFF0C\u53C2\u8003\u4E0B\u65B9\u8BA8\u8BBA\u5185\u5BB9</span>
      <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">ICapTransaction</span> <span class="token function">BeginTransaction</span><span class="token punctuation">(</span><span class="token keyword">this</span> <span class="token class-name">IUnitOfWork</span> unitOfWork<span class="token punctuation">,</span> <span class="token class-name">ICapPublisher</span> publisher<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">bool</span></span> autoCommit <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> dispatcher <span class="token operator">=</span> publisher<span class="token punctuation">.</span>ServiceProvider<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetRequiredService</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IDispatcher<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> transaction <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">FreeSqlRepositoryPatternTransaction</span><span class="token punctuation">(</span>dispatcher<span class="token punctuation">,</span> unitOfWork<span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                AutoCommit <span class="token operator">=</span> autoCommit
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> publisher<span class="token punctuation">.</span>Transaction<span class="token punctuation">.</span>Value <span class="token operator">=</span> transaction<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4F7F\u7528\u65B9\u5F0F\uFF1A</p><div class="language-csharp ext-cs line-numbers-mode"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">HttpGet</span><span class="token attribute-arguments"><span class="token punctuation">(</span><span class="token string">&quot;~/freesql/Withtransaction&quot;</span><span class="token punctuation">)</span></span></span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token return-type class-name">DateTime</span> <span class="token function">WithTransaction</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromServices</span></span><span class="token punctuation">]</span> <span class="token class-name">IBaseRepository<span class="token punctuation">&lt;</span>Book<span class="token punctuation">&gt;</span></span> repo<span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromServices</span></span><span class="token punctuation">]</span> <span class="token class-name">UnitOfWorkManager</span> unitOfWorkManager<span class="token punctuation">,</span>
<span class="token punctuation">[</span><span class="token attribute"><span class="token class-name">FromServices</span></span><span class="token punctuation">]</span> <span class="token class-name">ICapPublisher</span> capBus
<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">DateTime</span> now <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">;</span>
    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IUnitOfWork</span> uow <span class="token operator">=</span> unitOfWorkManager<span class="token punctuation">.</span><span class="token function">Begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">ICapTransaction</span> trans <span class="token operator">=</span> uow<span class="token punctuation">.</span><span class="token function">BeginTransaction</span><span class="token punctuation">(</span>capBus<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        repo<span class="token punctuation">.</span><span class="token function">Insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token constructor-invocation class-name">Book</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            Author <span class="token operator">=</span> <span class="token string">&quot;\u53F6\u8001\u677F&quot;</span><span class="token punctuation">,</span>
            Title <span class="token operator">=</span> <span class="token string">&quot;FreeSql\u6E90\u7801\u89E3\u6790\u4E0E\u5B9E\u6218&quot;</span><span class="token punctuation">,</span>
            Summary <span class="token operator">=</span> <span class="token string">&quot;\u5E26\u4F60\u4E86\u89E3FreeSql\u6E90\u7801\u7EC6\u8282\uFF0C\u638C\u63E1FreeSql\u7684\u5B9E\u6218\u64CD\u4F5C\uFF0C\u6269\u5C55FreeSql\u7684\u529F\u80FD\uFF0C\u63D0\u5347\u4F60\u7684\u5F00\u53D1\u6548\u7387\u3002&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        capBus<span class="token punctuation">.</span><span class="token function">Publish</span><span class="token punctuation">(</span><span class="token string">&quot;freesql.time&quot;</span><span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        trans<span class="token punctuation">.</span><span class="token function">Commit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> now<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E8C\u8005\u533A\u522B\u5728\u4E8E\u540E\u8005\uFF0C<code>trans.Commit()</code>\u4E0D\u9700\u8981\u4F20\u9012\`\`IUnitOfWork\`\u53C2\u6570</p><h2 id="\u539F\u6587\u53C2\u8003" tabindex="-1"><a class="header-anchor" href="#\u539F\u6587\u53C2\u8003" aria-hidden="true">#</a> \u539F\u6587\u53C2\u8003</h2>`,10),T={href:"https://www.cnblogs.com/igeekfan/p/cap_freesql_flush.html",target:"_blank",rel:"noopener noreferrer"},I=s("FreeSql \u63A5\u5165 CAP \u7684\u5B9E\u8DF5"),x={href:"https://github.com/dotnetcore/FreeSql/discussions/1202",target:"_blank",rel:"noopener noreferrer"},F=s("\u5982\u4F55\u4F7F FreeSql \u548C CAP \u8FDB\u884C\u96C6\u6210");function B(U,O){const a=o("ExternalLinkIcon");return c(),l("div",null,[u,r,n("p",null,[k,n("a",d,[v,t(a)]),m]),b,n("ul",null,[n("li",null,[h,n("a",g,[y,t(a)])])]),f,n("p",null,[w,n("a",q,[C,t(a)]),S]),_,n("ul",null,[n("li",null,[n("a",T,[I,t(a)])]),n("li",null,[n("a",x,[F,t(a)])])])])}var M=e(i,[["render",B],["__file","freesql-cap.html.vue"]]);export{M as default};
